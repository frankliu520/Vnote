# 1. RK3568添加YT3581网卡
## 1.1. 准备工作
搭建飞凌开发环境，可以自己搭建也可以用官方提供好的虚拟机，注意使用虚拟机或服务器，电脑配置大于内存大于16G,硬盘容量大于500G
下载飞凌嵌入式内核源码，先进行全编译，需要编译文件系统时，需单独编译，编译完成后会将生成的rootfs.img替换linuxfs/rootfs.img文件，后续执行build.sh仍然使用linuxfs/rootfs.img文件。具体参考官方指导文档[链接](https://forlinx-book.yuque.com/rh74yu/ok3568/lhbiespfy0rg1fq0)此处目的是为了获取交叉编译工具，为后续qt/svcode交差编译环境搭建提供基础，编译buildroot时间比较长耐心等待
## 1.2. 修改设备树文件
打开kernel/arch/arm64/boot/dts/rockchip/OK3568-C-common.dtsi 文件根据电路原理图修改phy芯片的配置信息此处注意观察使能引脚，确定phy芯片的地址。
```

&gmac0 {
	phy-mode = "rgmii-rxid";
	clock_in_out = "output";

	snps,reset-gpio = <&gpio1 RK_PD7 GPIO_ACTIVE_LOW>;
	snps,reset-active-low;
	/* Reset time is 20ms, 100ms for rtl8211f */
	snps,reset-delays-us = <0 20000 100000>;

	assigned-clocks = <&cru SCLK_GMAC0_RX_TX>, <&cru SCLK_GMAC0>, <&cru CLK_MAC0_OUT>;
	assigned-clock-parents = <&cru SCLK_GMAC0_RGMII_SPEED>;
	assigned-clock-rates = <0>, <125000000>, <25000000>;

	pinctrl-names = "default";
	pinctrl-0 = <&gmac0_miim
		     &gmac0_tx_bus2
		     &gmac0_rx_bus2
		     &gmac0_rgmii_clk
		     &gmac0_rgmii_bus
			 &eth0_pins>;

	tx_delay = <0x36>;
/*	rx_delay = <0x00>;  */

	phy-handle = <&rgmii_phy0>;
	status = "okay";
};

&gmac1 {
	phy-mode = "rgmii-rxid";
	clock_in_out = "output";

	snps,reset-gpio = <&gpio4 RK_PD2 GPIO_ACTIVE_LOW>;
	snps,reset-active-low;
	/* Reset time is 20ms, 100ms for rtl8211f */
	snps,reset-delays-us = <0 20000 100000>;

	assigned-clocks = <&cru SCLK_GMAC1_RX_TX>, <&cru SCLK_GMAC1>, <&cru CLK_MAC1_OUT>;
	assigned-clock-parents = <&cru SCLK_GMAC1_RGMII_SPEED>;
	assigned-clock-rates = <0>, <125000000>, <25000000>;

	pinctrl-names = "default";
	pinctrl-0 = <&gmac1m1_miim
		     &gmac1m1_tx_bus2
		     &gmac1m1_rx_bus2
		     &gmac1m1_rgmii_clk
		     &gmac1m1_rgmii_bus
			 &eth1m1_pins>;

	tx_delay = <0x36>;
/*	rx_delay = <0x00>; */

	phy-handle = <&rgmii_phy1>;
	status = "okay";
};

&mdio0 {
	rgmii_phy0: phy@1 {
		compatible = "ethernet-phy-ieee802.3-c22";
		reg = <0x1>;
		clocks = <&cru CLK_MAC0_OUT>;
	};
};

&mdio1 {
	rgmii_phy1: phy@1{
		compatible = "ethernet-phy-ieee802.3-c22";
		reg = <0x1>;
		clocks = <&cru CLK_MAC1_OUT>;
	};
};
```
## 1.3. 修改Kconfig
  `vim drivers/net/phy/Kconfig`打开文件  在 “PHY Device support and infrastructure” 节点里追加：
  ```
  config MOTORCOMM_PHY
	tristate "Motorcomm PHYs"
	help
	  Enables support for Motorcomm network PHYs.
	  Currently supports the YT8511, YT8521, YT8531, RK631 gigabit PHY.
  ```
## 1.4. 修改同级Makefile
`vim drivers/net/phy/Makefile`  追加：
```
 obj-$(CONFIG_MOTORCOMM_PHY) += motorcomm.o
```
按照官方指导文件参考4.2.2节注释添加修改内容
## 1.4. 配置meauconfig
从根目录下执行`cd  kernel`进入此文件夹然后执行` make ARCH=arm64 menuconfig`配置编译
路径：Device Drivers → Network device support → PHY Device support and infrastructure → <*> Motorcomm PHYs
选成 <*> 直接编进内核
保存退出后，.config 会自动出现：
`CONFIG_MOTORCOMM_PHY=y`
## 1.4. 编译
返回到上一级目录执行脚本`./build.sh kernel   `开始编译，编译完成后使用目录OK3568_Linux_fs/kernel/boot.img更新板子中的boot.img验证即可。
（因为编译时间比较长所以采用交互式编译，和交互操作使用 screen（推荐，适合交互式任务）如：
```
screen -S mysession #创建一个交互编译的会话 mysession为会话名称
# 按 Ctrl+A 然后按 D 键，安全脱离会话~~~~
screen -r mysession 回到会话
```
）